<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Peza - Emergency Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.cdnfonts.com/css/sf-pro-display');

    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f2f2f7; /* iOS light background */
      min-height: 100vh;
      overflow-x: hidden;
      color: #000;
      padding-bottom: 80px; /* Space for bottom nav */
      -webkit-font-smoothing: antialiased;
    }

    .header {
      background: rgba(255, 255, 255, 0.95); /* iOS translucent effect */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.2);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .page {
      display: none;
      animation: fadeIn 0.4s cubic-bezier(0.36, 0, 0.66, -0.56);
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .emergency-card {
      background: #fff;
      border-radius: 18px; /* iOS rounded corners */
      transition: transform 0.2s cubic-bezier(0.36, 0, 0.66, -0.56);
      cursor: pointer;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .emergency-card:active {
      transform: scale(0.98);
      background: rgba(0, 0, 0, 0.03);
    }

    .pulse-ring {
      animation: pulse 1.8s cubic-bezier(0.36, 0, 0.66, -0.56) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.08); }
    }

    .slide-up {
      animation: slideUp 0.4s cubic-bezier(0.36, 0, 0.66, -0.56);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #007aff; /* iOS blue */
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ios-shadow {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-dot.green {
      background-color: #34c759; /* iOS green */
    }

    .status-dot.red {
      background-color: #ff3b30; /* iOS red */
    }

    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #fff;
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 10px;
      transition: transform 0.2s cubic-bezier(0.36, 0, 0.66, -0.56);
    }

    .alert-item:active {
      transform: scale(0.98);
    }

    .alert-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .alert-icon.high { background: #ff3b3022; color: #ff3b30; }
    .alert-icon.medium { background: #ff950022; color: #ff9500; }
    .alert-icon.low, .alert-icon.weather, .alert-icon.time { background: #34c75922; color: #34c759; }

    .alert-content {
      flex: 1;
      min-width: 0;
    }

    .alert-title {
      font-size: 14px;
      font-weight: 600;
      color: #000;
      margin-bottom: 4px;
    }

    .alert-message, .alert-recommendation, .alert-time {
      font-size: 13px;
      color: #3c3c43;
      line-height: 1.4;
    }

    .alert-time {
      margin-top: 4px;
      color: #8e8e93;
    }

    .alert-badge {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 12px;
      margin-left: 8px;
    }

    .alert-badge.high { background: #ff3b30; color: #fff; }
    .alert-badge.medium { background: #ff9500; color: #fff; }
    .alert-badge.low, .alert-badge.weather, .alert-badge.time { background: #34c759; color: #fff; }

    .filter-btn {
      font-size: 12px;
      padding: 8px 14px;
      border-radius: 14px;
      background: #f2f2f7;
      color: #000;
      transition: all 0.2s cubic-bezier(0.36, 0, 0.66, -0.56);
    }

    .filter-btn.active, .filter-btn:hover {
      background: #007aff;
      color: #fff;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 0.5px solid rgba(0, 0, 0, 0.2);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px;
      cursor: pointer;
      color: #8e8e93;
      font-size: 11px;
      transition: all 0.2s cubic-bezier(0.36, 0, 0.66, -0.56);
    }

    .nav-item i {
      font-size: 22px;
    }

    .nav-item.active {
      color: #007aff;
    }

    .nav-item:active {
      transform: scale(0.95);
    }

    .weather-card {
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .weather-stat {
      background: #f2f2f7;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="max-w-md mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-[#007aff] rounded-full flex items-center justify-center pulse-ring">
          <span class="material-icons text-white text-lg">security</span>
        </div>
        <div>
          <h1 class="text-[#007aff] font-semibold text-lg">Peza</h1>
          <p class="text-[#8e8e93] text-xs" id="locationText"><span class="status-dot green"></span>Connected</p>
        </div>
      </div>
      <button onclick="refreshLocation()" class="text-[#8e8e93] p-2 hover:bg-[#f2f2f7] rounded-full transition">
        <span class="material-icons text-lg">refresh</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-md mx-auto px-4 py-4">
    <!-- Home Page -->
    <div id="homePage" class="page active">
      <!-- Greeting -->
      <div class="text-center mb-6 slide-up">
        <h2 id="welcome-title" class="text-lg font-semibold text-[#000]">Welcome, Guest!</h2>
        <p class="text-[#8e8e93] text-sm">Stay safe with Peza emergency services</p>
      </div>

      <!-- Emergency Services -->
      <div class="mb-6">
        <h3 class="text-[#000] font-semibold text-lg mb-4">Emergency Services</h3>
        <div class="grid grid-cols-2 gap-4">
          <div onclick="findService('police')" class="emergency-card ios-shadow slide-up">
            <div class="w-10 h-10 bg-[#007aff22] rounded-full flex items-center justify-center mb-3 mx-auto">
              <span class="material-icons text-[#007aff] text-lg">local_police</span>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Police</h3>
            <p class="text-[#8e8e93] text-xs text-center">Emergency Response</p>
          </div>
          <div onclick="findService('hospital')" class="emergency-card ios-shadow slide-up" style="animation-delay: 0.1s">
            <div class="w-10 h-10 bg-[#ff3b3022] rounded-full flex items-center justify-center mb-3 mx-auto">
              <span class="material-icons text-[#ff3b30] text-lg">local_hospital</span>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Hospital</h3>
            <p class="text-[#8e8e93] text-xs text-center">Medical Care</p>
          </div>
          <div onclick="findService('ambulance')" class="emergency-card ios-shadow slide-up" style="animation-delay: 0.2s">
            <div class="w-10 h-10 bg-[#34c75922] rounded-full flex items-center justify-center mb-3 mx-auto">
              <span class="material-icons text-[#34c759] text-lg">medical_services</span>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Ambulance</h3>
            <p class="text-[#8e8e93] text-xs text-center">Quick Transport</p>
          </div>
          <div onclick="findService('fire')" class="emergency-card ios-shadow slide-up" style="animation-delay: 0.3s">
            <div class="w-10 h-10 bg-[#ff950022] rounded-full flex items-center justify-center mb-3 mx-auto">
              <span class="material-icons text-[#ff9500] text-lg">local_fire_department</span>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Fire</h3>
            <p class="text-[#8e8e93] text-xs text-center">Fire Service</p>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="ios-shadow rounded-[18px] p-4 mb-6 slide-up" style="animation-delay: 0.4s">
        <h3 class="font-semibold text-sm mb-4">Quick Stats</h3>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="material-icons text-[#8e8e93] text-sm">access_time</span>
              <span class="text-sm">Avg Response Time</span>
            </div>
            <span class="font-semibold text-sm">~15 min</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="material-icons text-[#8e8e93] text-sm">place</span>
              <span class="text-sm">Search Radius</span>
            </div>
            <span class="font-semibold text-sm">5 km</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="material-icons text-[#8e8e93] text-sm">notifications</span>
              <span class="text-sm">Active Alerts</span>
            </div>
            <span class="font-semibold text-sm" id="homeAlertCount">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Weather Page -->
    <div id="weatherPage" class="page">
      <!-- Current Weather -->
      <div class="weather-card ios-shadow slide-up">
        <div class="text-center mb-4">
          <span class="material-icons text-5xl mb-2" id="weatherIcon">cloud</span>
          <h2 class="text-2xl font-semibold mb-1" id="mainTemp">--°</h2>
          <p class="text-base font-medium mb-1" id="weatherCondition">Loading...</p>
          <p class="text-sm text-[#8e8e93]" id="weatherLocation">Getting location...</p>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="weather-stat">
            <span class="material-icons text-base mb-1">water_drop</span>
            <p class="text-sm text-[#8e8e93]">Humidity</p>
            <p class="text-sm font-semibold" id="humidity">--%</p>
          </div>
          <div class="weather-stat">
            <span class="material-icons text-base mb-1">air</span>
            <p class="text-sm text-[#8e8e93]">Wind</p>
            <p class="text-sm font-semibold" id="windSpeed">-- km/h</p>
          </div>
          <div class="weather-stat">
            <span class="material-icons text-base mb-1">wb_sunny</span>
            <p class="text-sm text-[#8e8e93]">UV Index</p>
            <p class="text-sm font-semibold" id="uvIndex">--</p>
          </div>
        </div>
      </div>

      <!-- Weather Alerts -->
      <div class="ios-shadow rounded-[18px] p-4 mb-6 slide-up" style="animation-delay: 0.1s">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-sm">Weather Alerts</h3>
          <span class="text-sm text-[#8e8e93]" id="weatherAlertCount">0 alerts</span>
        </div>
        <div id="weatherAlertsList" class="space-y-3"></div>
      </div>

      <!-- Forecast -->
      <div class="ios-shadow rounded-[18px] p-4 slide-up" style="animation-delay: 0.2s">
        <h3 class="font-semibold text-sm mb-4">Today's Forecast</h3>
        <div class="text-center text-[#8e8e93] text-sm py-4">
          <span class="material-icons text-2xl mb-1">schedule</span>
          <p>Hourly forecast coming soon</p>
        </div>
      </div>
    </div>

    <!-- Alerts Page -->
    <div id="alertsPage" class="page">
      <div class="ios-shadow rounded-[18px] p-4 mb-6 slide-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-sm">All Alerts <span id="alert-count" class="text-sm text-[#8e8e93] ml-1">0</span></h3>
          <button onclick="refreshAlerts()" class="text-[#8e8e93] p-2 hover:bg-[#f2f2f7] rounded-full transition">
            <span class="material-icons text-lg">refresh</span>
          </button>
        </div>
        <input id="alertSearch" type="text" placeholder="Search alerts..." class="w-full px-4 py-2 bg-[#f2f2f7] rounded-[14px] text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-[#007aff]">
        <div class="flex flex-wrap gap-2 mb-4">
          <button onclick="filterAlerts('all')" class="filter-btn active">All</button>
          <button onclick="filterAlerts('high')" class="filter-btn">High</button>
          <button onclick="filterAlerts('medium')" class="filter-btn">Medium</button>
          <button onclick="filterAlerts('low')" class="filter-btn">Low</button>
          <button onclick="filterAlerts('weather')" class="filter-btn">Weather</button>
          <button onclick="filterAlerts('time')" class="filter-btn">Time</button>
        </div>
        <div id="current-time" class="text-sm text-[#8e8e93] mb-4">Last updated: --:--:--</div>
        <div id="alerts-list" class="space-y-3"></div>
        <div id="no-alerts" class="text-center text-[#8e8e93] text-sm py-4 hidden">
          <span class="material-icons text-2xl mb-1">notifications_off</span>
          <p>No alerts at the moment</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div id="resultsModal" class="fixed inset-0 bg-black/30 hidden z-50">
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[24px] max-h-[80vh] overflow-hidden">
      <div class="sticky top-0 bg-white border-b border-[#d1d1d6] p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold text-sm" id="modalTitle">Nearby Services</h3>
          <button onclick="closeModal()" class="text-[#8e8e93] p-2 hover:bg-[#f2f2f7] rounded-full">
            <span class="material-icons text-lg">close</span>
          </button>
        </div>
        <div class="flex items-center gap-2 text-[#8e8e93] text-sm">
          <span class="material-icons text-sm">location_on</span>
          <span id="modalSubtitle">Searching...</span>
        </div>
      </div>
      <div id="loadingState" class="flex flex-col items-center justify-center py-12">
        <div class="loading-spinner mb-3"></div>
        <p class="text-sm">Finding services nearby...</p>
      </div>
      <div id="resultsList" class="overflow-y-auto max-h-[calc(80vh-90px)] p-4 space-y-3 hidden"></div>
      <div id="noResults" class="hidden flex flex-col items-center justify-center py-12">
        <span class="material-icons text-[#8e8e93] text-3xl mb-2">place</span>
        <p class="font-semibold text-sm">No services found</p>
        <p class="text-[#8e8e93] text-sm text-center">Try expanding your search radius</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="max-w-md mx-auto px-4 py-2">
      <div class="flex items-center justify-around">
        <div class="nav-item active" onclick="switchPage('home')">
          <span class="material-icons">home</span>
          <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchPage('weather')">
          <span class="material-icons">cloud</span>
          <span>Weather</span>
        </div>
        <div class="nav-item" onclick="switchPage('alerts')">
          <span class="material-icons">notifications</span>
          <span>Alerts</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let userLocation = null;
    const API_BASE_URL = 'https://app.pezamw.com';
    const apiKey = 'b0497bc522524401831134643231610';
    let currentAlerts = [];
    let weatherData = null;
    let currentPage = 'home';

    // Page Navigation
    function switchPage(page) {
      currentPage = page;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(page + 'Page').classList.add('active');
      event.target.closest('.nav-item').classList.add('active');
      
      if (page === 'weather') {
        updateWeatherDisplay();
      }
    }

    // Greeting
    function updateWelcomeMessage() {
      const hour = new Date().getHours();
      const welcomeTitle = document.getElementById('welcome-title');
      const username = "{{ user.username }}" || "Guest";
      if (hour < 12) welcomeTitle.textContent = `Mwadzuka, ${username}!`;
      else if (hour < 17) welcomeTitle.textContent = `Mwaswera bwanji, ${username}!`;
      else welcomeTitle.textContent = `Mulibwanji, ${username}!`;
    }

    // Location
    function getCurrentLocation() {
      const locationText = document.getElementById('locationText');
      if (navigator.geolocation) {
        locationText.innerHTML = '<span class="status-dot green"></span>Getting location...';
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            locationText.innerHTML = '<span class="status-dot green"></span>Connected';
            fetchWeatherAndAlerts();
          },
          err => {
            console.error('Location error:', err);
            locationText.innerHTML = '<span class="status-dot red"></span>Location unavailable';
            userLocation = { lat: -13.9626, lon: 33.7741 };
            fetchWeatherAndAlerts();
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        locationText.innerHTML = '<span class="status-dot red"></span>Not supported';
        userLocation = { lat: -13.9626, lon: 33.7741 };
        fetchWeatherAndAlerts();
      }
    }

    function refreshLocation() {
      getCurrentLocation();
    }

    // Services
    async function findService(category) {
      if (!userLocation) return alert('Location not detected yet');
      const modal = document.getElementById('resultsModal');
      const loadingState = document.getElementById('loadingState');
      const resultsList = document.getElementById('resultsList');
      const noResults = document.getElementById('noResults');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');

      const titles = { 
        police: 'Police Stations', 
        hospital: 'Hospitals', 
        ambulance: 'Ambulance Services', 
        fire: 'Fire Stations' 
      };
      modalTitle.textContent = titles[category] || 'Emergency Services';
      modalSubtitle.textContent = 'Searching nearby...';
      modal.classList.remove('hidden');
      loadingState.classList.remove('hidden');
      resultsList.classList.add('hidden');
      noResults.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE_URL}/api/peza/?lat=${userLocation.lat}&lon=${userLocation.lon}&category=${category}`);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        loadingState.classList.add('hidden');
        modalSubtitle.textContent = `Found ${data.locations?.length || 0} locations`;
        data.locations?.length ? displayResults(data.locations, category) : noResults.classList.remove('hidden');
      } catch (err) {
        console.error('Error:', err);
        loadingState.classList.add('hidden');
        noResults.classList.remove('hidden');
      }
    }

    function displayResults(locations, category) {
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '';
      resultsList.classList.remove('hidden');

      const icons = { 
        police: 'local_police', 
        hospital: 'local_hospital', 
        ambulance: 'medical_services', 
        fire: 'local_fire_department' 
      };
      const colors = { 
        police: '#007aff', 
        hospital: '#ff3b30', 
        ambulance: '#34c759', 
        fire: '#ff9500' 
      };

      locations.forEach((loc, i) => {
        const item = document.createElement('div');
        item.className = 'ios-shadow rounded-[18px] p-4 slide-up';
        item.style.animationDelay = `${i * 0.05}s`;
        item.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-[12px] flex items-center justify-center" style="background: ${colors[category]}22;">
              <span class="material-icons" style="color: ${colors[category]}; font-size: 20px;">${icons[category]}</span>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-sm mb-1 truncate">${loc.name}</h4>
              <p class="text-[#8e8e93] text-sm mb-2 line-clamp-2">${loc.address}</p>
              <div class="flex items-center gap-2 mb-2 text-sm text-[#8e8e93]">
                <span class="material-icons text-sm">place</span>
                <span>${loc.distance}</span>
              </div>
              <div class="flex gap-3">
                <button onclick="callLocation('${loc.phone || 'N/A'}')" class="flex-1 bg-[#007aff] hover:bg-[#0051c7] text-white px-4 py-2 rounded-[14px] text-sm font-medium flex items-center justify-center gap-2 transition">
                  <span class="material-icons text-sm">phone</span> Call
                </button>
                <button onclick="openMaps(${loc.lat}, ${loc.lon}, '${loc.name}')" class="flex-1 bg-[#f2f2f7] hover:bg-[#e5e5ea] text-[#000] px-4 py-2 rounded-[14px] text-sm font-medium flex items-center justify-center gap-2 transition">
                  <span class="material-icons text-sm">navigation</span> Directions
                </button>
              </div>
            </div>
          </div>
        `;
        resultsList.appendChild(item);
      });
    }

    function callLocation(phone) {
      if (phone === 'N/A') return alert('Phone number not available');
      window.location.href = `tel:${phone}`;
    }

    function openMaps(lat, lon, name) {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&destination_place_id=${encodeURIComponent(name)}`, '_blank');
    }

    function closeModal() {
      document.getElementById('resultsModal').classList.add('hidden');
    }

    // Weather Display
    function updateWeatherDisplay() {
      if (!weatherData) return;
      
      const { current, location } = weatherData;
      document.getElementById('mainTemp').textContent = `${Math.round(current.temp_c)}°C`;
      document.getElementById('weatherCondition').textContent = current.condition.text;
      document.getElementById('weatherLocation').textContent = `${location.name}, ${location.country}`;
      document.getElementById('humidity').textContent = `${current.humidity}%`;
      document.getElementById('windSpeed').textContent = `${Math.round(current.wind_kph)} km/h`;
      document.getElementById('uvIndex').textContent = current.uv;
      
      const condition = current.condition.text.toLowerCase();
      let iconName = 'cloud';
      if (condition.includes('sun') || condition.includes('clear')) iconName = 'wb_sunny';
      else if (condition.includes('rain')) iconName = 'umbrella';
      else if (condition.includes('snow')) iconName = 'ac_unit';
      else if (condition.includes('storm') || condition.includes('thunder')) iconName = 'bolt';
      else if (condition.includes('fog') || condition.includes('mist')) iconName = 'cloud_queue';
      
      document.getElementById('weatherIcon').textContent = iconName;
      
      const weatherAlerts = currentAlerts.filter(a => a.type === 'weather');
      const weatherAlertsList = document.getElementById('weatherAlertsList');
      const weatherAlertCount = document.getElementById('weatherAlertCount');
      
      if (weatherAlerts.length === 0) {
        weatherAlertsList.innerHTML = '<p class="text-center text-[#8e8e93] text-sm py-2">No weather alerts</p>';
        weatherAlertCount.textContent = '0 alerts';
      } else {
        weatherAlertsList.innerHTML = '';
        weatherAlerts.forEach(alert => {
          weatherAlertsList.appendChild(createAlertElement(alert));
        });
        weatherAlertCount.textContent = `${weatherAlerts.length} alert${weatherAlerts.length > 1 ? 's' : ''}`;
      }
    }

    // Alerts
    function getAlertIcon(type, severity) {
      const icons = {
        safety: {
          high: 'warning',
          medium: 'lock',
          low: 'info'
        },
        time: {
          high: 'nights_stay',
          medium: 'traffic',
          low: 'schedule'
        },
        weather: {
          rain: 'umbrella',
          sun: 'wb_sunny',
          snow: 'ac_unit',
          wind: 'air',
          default: 'cloud'
        }
      };
      return icons[type]?.[severity] || icons[type]?.default || icons.safety.low;
    }

    function createAlertElement(alert) {
      const div = document.createElement('div');
      div.className = `alert-item slide-up`;
      div.setAttribute('data-priority', alert.severity);
      div.setAttribute('data-type', alert.type);
      div.innerHTML = `
        <div class="alert-icon ${alert.type === 'weather' ? 'weather' : alert.type === 'time' ? 'time' : alert.severity}">
          <span class="material-icons">${getAlertIcon(alert.type, alert.severity)}</span>
        </div>
        <div class="alert-content">
          <div class="flex items-center justify-between mb-1">
            <div class="alert-title">${alert.title}</div>
            <span class="alert-badge ${alert.type === 'weather' ? 'weather' : alert.type === 'time' ? 'time' : alert.severity}">
              ${alert.type === 'weather' ? 'Weather' : alert.type === 'time' ? 'Time-based' : alert.severity.charAt(0).toUpperCase() + alert.severity.slice(1)}
            </span>
          </div>
          <div class="alert-message">${alert.message}</div>
          ${alert.recommendation ? `<div class="alert-recommendation">Tip: ${alert.recommendation}</div>` : ''}
          <div class="alert-time">${new Date().toLocaleTimeString()} • Live</div>
        </div>
      `;
      return div;
    }

    function checkTimeBasedAlerts(hour) {
      const alerts = [];
      
      if (hour >= 21 || hour <= 5) {
        if (hour >= 0 && hour <= 3) {
          alerts.push({
            type: 'time',
            title: 'Very Late Night - High Risk',
            message: 'This is the most dangerous time period. Crime rates are highest between midnight and 3 AM.',
            recommendation: 'Stay indoors if possible. If you must go out, travel in groups and stay in well-lit areas.',
            severity: 'high'
          });
        } else {
          alerts.push({
            type: 'time',
            title: 'Night Time Safety Alert',
            message: 'Increased risk of crime during late hours. Limited visibility and fewer people around.',
            recommendation: 'Avoid walking alone. Keep phone charged and share location with trusted contacts.',
            severity: hour >= 22 || hour <= 4 ? 'high' : 'medium'
          });
        }
      }
      
      if (hour >= 6 && hour <= 8) {
        alerts.push({
          type: 'time',
          title: 'Morning Rush Hour',
          message: 'Heavy traffic and crowded streets. Increased risk of accidents and petty theft.',
          recommendation: 'Use designated crosswalks. Keep valuables secure in crowds. Allow extra travel time.',
          severity: 'medium'
        });
      }
      
      if (hour >= 12 && hour <= 13) {
        alerts.push({
          type: 'time',
          title: 'Lunch Hour Rush',
          message: 'Busy period with increased foot traffic in commercial areas.',
          recommendation: 'Be aware of your surroundings. Watch for pickpockets in crowded places.',
          severity: 'low'
        });
      }
      
      if (hour >= 17 && hour <= 19) {
        alerts.push({
          type: 'time',
          title: 'Evening Rush Hour',
          message: 'Peak traffic time. Roads are congested and visibility may be reduced as it gets darker.',
          recommendation: 'Drive defensively. Use headlights. Avoid busy intersections if possible.',
          severity: 'medium'
        });
      }
      
      if (hour >= 19 && hour <= 20) {
        alerts.push({
          type: 'time',
          title: 'Evening Transition Period',
          message: 'Daylight fading. This is when many crimes begin to increase.',
          recommendation: 'Head home before it gets too late. Be extra vigilant in parking areas.',
          severity: 'medium'
        });
      }
      
      if (hour >= 9 && hour <= 16) {
        alerts.push({
          type: 'time',
          title: 'Daytime Hours - Lower Risk',
          message: 'This is generally the safest time period with good visibility and more people around.',
          recommendation: 'Still remain aware of your surroundings. Report any suspicious activity.',
          severity: 'low'
        });
      }
      
      return alerts;
    }

    function checkWeatherAlerts(data) {
      const alerts = [];
      const { temp_c: temp, condition: { text: condition }, humidity, wind_kph: wind, uv } = data.current;

      if (temp > 35) {
        alerts.push({ 
          type: 'weather', 
          title: 'Extreme Heat Warning', 
          message: `Temperature: ${temp}°C. Risk of heat exhaustion and heat stroke.`, 
          recommendation: 'Stay hydrated, avoid direct sunlight, seek air-conditioned spaces.', 
          severity: 'high' 
        });
      } else if (temp > 30) {
        alerts.push({ 
          type: 'weather', 
          title: 'Hot Weather Alert', 
          message: `Temperature: ${temp}°C. High heat conditions.`, 
          recommendation: 'Use sunscreen SPF 30+, wear light clothing, drink plenty of water.', 
          severity: 'medium' 
        });
      } else if (temp < 5) {
        alerts.push({ 
          type: 'weather', 
          title: 'Cold Weather Warning', 
          message: `Temperature: ${temp}°C. Risk of hypothermia.`, 
          recommendation: 'Dress in layers, cover extremities, limit time outdoors.', 
          severity: 'high' 
        });
      } else if (temp < 10) {
        alerts.push({ 
          type: 'weather', 
          title: 'Chilly Weather', 
          message: `Temperature: ${temp}°C. Cold conditions.`, 
          recommendation: 'Wear warm clothing, especially in wind.', 
          severity: 'low' 
        });
      }

      if (condition.toLowerCase().includes('rain')) {
        const severity = condition.toLowerCase().includes('heavy') ? 'high' : 'medium';
        alerts.push({ 
          type: 'weather', 
          title: severity === 'high' ? 'Heavy Rain Warning' : 'Rain Alert', 
          message: 'Wet conditions causing slippery roads and reduced visibility.', 
          recommendation: 'Use umbrella, drive slowly, watch for flooding in low areas.', 
          severity 
        });
      }
      
      if (condition.toLowerCase().includes('snow')) {
        alerts.push({ 
          type: 'weather', 
          title: 'Snow Alert', 
          message: 'Snowy conditions with slippery surfaces and reduced visibility.', 
          recommendation: 'Wear waterproof boots, drive very carefully, allow extra travel time.', 
          severity: 'high' 
        });
      }
      
      if (condition.toLowerCase().includes('thunderstorm') || condition.toLowerCase().includes('thunder')) {
        alerts.push({ 
          type: 'weather', 
          title: 'Thunderstorm Warning', 
          message: 'Active thunderstorm with lightning risk. Dangerous conditions.', 
          recommendation: 'Stay indoors, avoid trees and open areas, unplug electronics.', 
          severity: 'high' 
        });
      }

      if (wind > 50) {
        alerts.push({ 
          type: 'weather', 
          title: 'Severe Wind Warning', 
          message: `Wind speed: ${wind} km/h. Risk of flying debris and property damage.`, 
          recommendation: 'Stay indoors, secure loose objects, avoid driving high-profile vehicles.', 
          severity: 'high' 
        });
      } else if (wind > 40) {
        alerts.push({ 
          type: 'weather', 
          title: 'High Wind Alert', 
          message: `Wind speed: ${wind} km/h. Strong gusts possible.`, 
          recommendation: 'Secure outdoor items, be careful when walking near buildings.', 
          severity: 'medium' 
        });
      }

      if (uv > 10) {
        alerts.push({ 
          type: 'weather', 
          title: 'Extreme UV Warning', 
          message: `UV Index: ${uv}. Very high risk of sun damage.`, 
          recommendation: 'Avoid sun 10 AM-4 PM, use SPF 50+, wear protective clothing and sunglasses.', 
          severity: 'high' 
        });
      } else if (uv > 7) {
        alerts.push({ 
          type: 'weather', 
          title: 'High UV Alert', 
          message: `UV Index: ${uv}. Significant sun exposure risk.`, 
          recommendation: 'Use SPF 30+ sunscreen, wear hat and sunglasses, seek shade.', 
          severity: 'medium' 
        });
      }

      if (humidity > 85) {
        alerts.push({ 
          type: 'weather', 
          title: 'Very High Humidity', 
          message: `Humidity: ${humidity}%. Oppressive conditions, feels hotter than actual temperature.`, 
          recommendation: 'Stay hydrated, use dehumidifier indoors, limit strenuous activity.', 
          severity: 'medium' 
        });
      } else if (humidity > 80) {
        alerts.push({ 
          type: 'weather', 
          title: 'High Humidity Notice', 
          message: `Humidity: ${humidity}%. Muggy conditions.`, 
          recommendation: 'Stay cool and hydrated.', 
          severity: 'low' 
        });
      }

      return alerts;
    }

    function displayAlerts(alerts) {
      const container = document.getElementById('alerts-list');
      const noAlertsDiv = document.getElementById('no-alerts');
      const alertCount = document.getElementById('alert-count');
      const homeAlertCount = document.getElementById('homeAlertCount');
      
      container.innerHTML = '';
      
      if (!alerts.length) {
        noAlertsDiv.classList.remove('hidden');
        alertCount.textContent = '0';
        homeAlertCount.textContent = '0';
        return;
      }
      
      noAlertsDiv.classList.add('hidden');
      alertCount.textContent = alerts.length;
      homeAlertCount.textContent = alerts.length;
      
      alerts.forEach(alert => container.appendChild(createAlertElement(alert)));
    }

    function updateTimeAndAlerts() {
      const now = new Date();
      document.getElementById('current-time').textContent = `Last updated: ${now.toLocaleTimeString()}`;
      
      const timeAlerts = checkTimeBasedAlerts(now.getHours());
      const weatherAlerts = weatherData ? checkWeatherAlerts(weatherData) : [];
      
      currentAlerts = [...timeAlerts, ...weatherAlerts];
      displayAlerts(currentAlerts);
      
      if (currentPage === 'weather') {
        updateWeatherDisplay();
      }
    }

    async function fetchWeatherAndAlerts() {
      if (userLocation) {
        try {
          const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${userLocation.lat},${userLocation.lon}`);
          if (!res.ok) throw new Error('Weather fetch failed');
          weatherData = await res.json();
        } catch (err) {
          console.error('Weather error:', err);
          document.getElementById('weatherLocation').textContent = 'Weather data unavailable';
        }
      }
      updateTimeAndAlerts();
    }

    function refreshAlerts() {
      fetchWeatherAndAlerts();
    }

    function filterAlerts(filter) {
      const alerts = document.querySelectorAll('.alert-item');
      const buttons = document.querySelectorAll('.filter-btn');
      
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      let visibleCount = 0;
      alerts.forEach(alert => {
        const priority = alert.getAttribute('data-priority');
        const type = alert.getAttribute('data-type');
        const show = filter === 'all' || priority === filter || type === filter;
        alert.style.display = show ? 'flex' : 'none';
        if (show) visibleCount++;
      });
      
      document.getElementById('alert-count').textContent = visibleCount;
      document.getElementById('no-alerts').style.display = visibleCount ? 'none' : 'block';
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      updateWelcomeMessage();
      getCurrentLocation();
      setInterval(updateTimeAndAlerts, 60000);
    });

    document.getElementById('resultsModal').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.getElementById('alertSearch').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const alerts = document.querySelectorAll('.alert-item');
      let visibleCount = 0;
      
      alerts.forEach(alert => {
        const content = alert.textContent.toLowerCase();
        const show = content.includes(term);
        alert.style.display = show ? 'flex' : 'none';
        if (show) visibleCount++;
      });
      
      document.getElementById('alert-count').textContent = visibleCount;
      document.getElementById('no-alerts').style.display = visibleCount ? 'none' : 'block';
    });
  </script>
</body>
</html>