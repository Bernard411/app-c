<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Peza - Emergency Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f0f0; /* WhatsApp light gray background */
      min-height: 100vh;
      overflow-x: hidden;
      color: #111b21; /* WhatsApp dark text */
      padding-bottom: 70px; /* Reduced for mobile */
    }
    
    .header {
      background: white;
      border-bottom: 1px solid #e4e6eb;
      padding: 12px 16px; /* Compact padding */
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .page {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .emergency-card {
      background: white;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
      padding: 12px; /* Reduced for mobile */
    }
    
    .emergency-card:active {
      transform: scale(0.98);
      background: rgba(0, 0, 0, 0.05);
    }
    
    .pulse-ring {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid #00a884; /* WhatsApp teal */
      border-radius: 50%;
      width: 32px; /* Smaller for mobile */
      height: 32px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .whatsapp-shadow {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }
    
    .status-dot.green {
      background-color: #00a884; /* WhatsApp teal */
    }
    
    .status-dot.red {
      background-color: #d32f2f;
    }
    
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 8px; /* Reduced for mobile */
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .alert-item:active {
      transform: scale(0.98);
    }
    
    .alert-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
    }
    
    .alert-icon.high { background: #fee6e9; color: #d32f2f; }
    .alert-icon.medium { background: #fff8e1; color: #f57c00; }
    .alert-icon.low, .alert-icon.weather, .alert-icon.time { background: #e6f3f1; color: #00a884; }
    
    .alert-content {
      flex: 1;
      min-width: 0;
    }
    
    .alert-title {
      font-size: 13px; /* Smaller for mobile */
      font-weight: 600;
      color: #111b21;
      margin-bottom: 3px;
    }
    
    .alert-message, .alert-recommendation, .alert-time {
      font-size: 12px;
      color: #65676b;
      line-height: 1.4;
    }
    
    .alert-time {
      margin-top: 3px;
      color: #8696a0;
    }
    
    .alert-badge {
      font-size: 10px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
    }
    
    .alert-badge.high { background: #d32f2f; color: white; }
    .alert-badge.medium { background: #f57c00; color: white; }
    .alert-badge.low, .alert-badge.weather, .alert-badge.time { background: #00a884; color: white; }
    
    .filter-btn {
      font-size: 11px; /* Smaller for mobile */
      padding: 6px 12px;
      border-radius: 12px;
      background: #e4e6eb;
      color: #111b21;
      transition: all 0.2s;
    }
    
    .filter-btn.active, .filter-btn:hover {
      background: #00a884;
      color: white;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e4e6eb;
      box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 8px; /* Reduced for mobile */
      cursor: pointer;
      color: #65676b;
      font-size: 10px; /* Smaller for mobile */
      transition: all 0.2s;
    }
    
    .nav-item i {
      font-size: 20px; /* Smaller for mobile */
    }
    
    .nav-item.active {
      color: #00a884;
    }
    
    .nav-item:active {
      transform: scale(0.95);
    }
    
    .weather-card {
      background: white;
      border-radius: 12px;
      padding: 12px; /* Reduced for mobile */
      margin-bottom: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .weather-stat {
      background: #e6f3f1;
      border-radius: 8px;
      padding: 8px; /* Reduced for mobile */
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="max-w-md mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 bg-[#00a884] rounded-full flex items-center justify-center pulse-ring">
          <i class='bx bxs-shield-alt-2 text-white text-lg'></i>
        </div>
        <div>
          <h1 class="text-[#00a884] font-semibold text-base">Peza</h1>
          <p class="text-gray-600 text-xs" id="locationText"><span class="status-dot green"></span>Connected</p>
        </div>
      </div>
      <button onclick="refreshLocation()" class="text-gray-600 p-1 hover:bg-gray-100 rounded-full transition">
        <i class='bx bx-refresh text-lg'></i>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-md mx-auto px-4 py-4">
    <!-- Home Page -->
    <div id="homePage" class="page active">
      <!-- Greeting -->
      <div class="text-center mb-4 slide-up">
        <h2 id="welcome-title" class="text-base font-semibold text-[#111b21]">Welcome, Guest!</h2>
        <p class="text-gray-600 text-xs">Stay safe with Peza emergency services</p>
      </div>

      <!-- Emergency Services -->
      <div class="mb-4">
        <h3 class="text-[#111b21] font-semibold text-base mb-3">Emergency Services</h3>
        <div class="grid grid-cols-2 gap-3">
          <div onclick="findService('police')" class="emergency-card whatsapp-shadow slide-up">
            <div class="w-8 h-8 bg-[#e6f3f1] rounded-full flex items-center justify-center mb-2 mx-auto">
              <i class='bx bxs-shield text-[#00a884] text-base'></i>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Police</h3>
            <p class="text-gray-600 text-xs text-center">Emergency Response</p>
          </div>
          <div onclick="findService('hospital')" class="emergency-card whatsapp-shadow slide-up" style="animation-delay: 0.1s">
            <div class="w-8 h-8 bg-[#fee6e9] rounded-full flex items-center justify-center mb-2 mx-auto">
              <i class='bx bxs-hospital text-[#d32f2f] text-base'></i>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Hospital</h3>
            <p class="text-gray-600 text-xs text-center">Medical Care</p>
          </div>
          <div onclick="findService('ambulance')" class="emergency-card whatsapp-shadow slide-up" style="animation-delay: 0.2s">
            <div class="w-8 h-8 bg-[#e6f3e6] rounded-full flex items-center justify-center mb-2 mx-auto">
              <i class='bx bxs-ambulance text-[#2e7d32] text-base'></i>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Ambulance</h3>
            <p class="text-gray-600 text-xs text-center">Quick Transport</p>
          </div>
          <div onclick="findService('fire')" class="emergency-card whatsapp-shadow slide-up" style="animation-delay: 0.3s">
            <div class="w-8 h-8 bg-[#ffefe6] rounded-full flex items-center justify-center mb-2 mx-auto">
              <i class='bx bxs-fire text-[#f57c00] text-base'></i>
            </div>
            <h3 class="font-semibold text-sm text-center mb-1">Fire</h3>
            <p class="text-gray-600 text-xs text-center">Fire Service</p>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="whatsapp-shadow rounded-12px p-3 mb-4 slide-up" style="animation-delay: 0.4s">
        <h3 class="font-semibold text-sm mb-3">Quick Stats</h3>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class='bx bx-time-five text-gray-600 text-sm'></i>
              <span class="text-xs">Avg Response Time</span>
            </div>
            <span class="font-semibold text-xs">~15 min</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class='bx bx-map text-gray-600 text-sm'></i>
              <span class="text-xs">Search Radius</span>
            </div>
            <span class="font-semibold text-xs">5 km</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i class='bx bx-bell text-gray-600 text-sm'></i>
              <span class="text-xs">Active Alerts</span>
            </div>
            <span class="font-semibold text-xs" id="homeAlertCount">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Weather Page -->
    <div id="weatherPage" class="page">
      <!-- Current Weather -->
      <div class="weather-card whatsapp-shadow slide-up">
        <div class="text-center mb-3">
          <i class='bx bx-cloud text-4xl mb-2' id="weatherIcon"></i>
          <h2 class="text-xl font-semibold mb-1" id="mainTemp">--°</h2>
          <p class="text-sm font-medium mb-1" id="weatherCondition">Loading...</p>
          <p class="text-xs text-gray-600" id="weatherLocation">Getting location...</p>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div class="weather-stat">
            <i class='bx bx-droplet text-base mb-1'></i>
            <p class="text-xs text-gray-600">Humidity</p>
            <p class="text-sm font-semibold" id="humidity">--%</p>
          </div>
          <div class="weather-stat">
            <i class='bx bx-wind text-base mb-1'></i>
            <p class="text-xs text-gray-600">Wind</p>
            <p class="text-sm font-semibold" id="windSpeed">-- km/h</p>
          </div>
          <div class="weather-stat">
            <i class='bx bx-sun text-base mb-1'></i>
            <p class="text-xs text-gray-600">UV Index</p>
            <p class="text-sm font-semibold" id="uvIndex">--</p>
          </div>
        </div>
      </div>

      <!-- Weather Alerts -->
      <div class="whatsapp-shadow rounded-12px p-3 mb-4 slide-up" style="animation-delay: 0.1s">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Weather Alerts</h3>
          <span class="text-xs text-gray-600" id="weatherAlertCount">0 alerts</span>
        </div>
        <div id="weatherAlertsList" class="space-y-2"></div>
      </div>

      <!-- Forecast -->
      <div class="whatsapp-shadow rounded-12px p-3 slide-up" style="animation-delay: 0.2s">
        <h3 class="font-semibold text-sm mb-3">Today's Forecast</h3>
        <div class="text-center text-gray-600 text-xs py-4">
          <i class='bx bx-time text-2xl mb-1'></i>
          <p>Hourly forecast coming soon</p>
        </div>
      </div>
    </div>

    <!-- Alerts Page -->
    <div id="alertsPage" class="page">
      <div class="whatsapp-shadow rounded-12px p-3 mb-4 slide-up">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">All Alerts <span id="alert-count" class="text-xs text-gray-600 ml-1">0</span></h3>
          <button onclick="refreshAlerts()" class="text-gray-600 p-1 hover:bg-gray-100 rounded-full transition">
            <i class='bx bx-refresh text-lg'></i>
          </button>
        </div>
        <input id="alertSearch" type="text" placeholder="Search alerts..." class="w-full px-3 py-1.5 bg-gray-100 rounded-lg text-xs mb-3 focus:outline-none focus:ring-2 focus:ring-[#00a884]">
        <div class="flex flex-wrap gap-1 mb-3">
          <button onclick="filterAlerts('all')" class="filter-btn active">All</button>
          <button onclick="filterAlerts('high')" class="filter-btn">High</button>
          <button onclick="filterAlerts('medium')" class="filter-btn">Medium</button>
          <button onclick="filterAlerts('low')" class="filter-btn">Low</button>
          <button onclick="filterAlerts('weather')" class="filter-btn">Weather</button>
          <button onclick="filterAlerts('time')" class="filter-btn">Time</button>
        </div>
        <div id="current-time" class="text-xs text-gray-600 mb-3">Last updated: --:--:--</div>
        <div id="alerts-list" class="space-y-2"></div>
        <div id="no-alerts" class="text-center text-gray-600 text-xs py-4 hidden">
          <i class='bx bx-bell-off text-2xl mb-1'></i>
          <p>No alerts at the moment</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div id="resultsModal" class="fixed inset-0 bg-black/30 hidden z-50">
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] overflow-hidden">
      <div class="sticky top-0 bg-white border-b border-gray-200 p-3">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold text-sm" id="modalTitle">Nearby Services</h3>
          <button onclick="closeModal()" class="text-gray-600 p-1 hover:bg-gray-100 rounded-full">
            <i class='bx bx-x text-lg'></i>
          </button>
        </div>
        <div class="flex items-center gap-2 text-gray-600 text-xs">
          <i class='bx bx-current-location text-sm'></i>
          <span id="modalSubtitle">Searching...</span>
        </div>
      </div>
      <div id="loadingState" class="flex flex-col items-center justify-center py-12">
        <div class="loading-spinner mb-2"></div>
        <p class="text-xs">Finding services nearby...</p>
      </div>
      <div id="resultsList" class="overflow-y-auto max-h-[calc(80vh-90px)] p-3 space-y-2 hidden"></div>
      <div id="noResults" class="hidden flex flex-col items-center justify-center py-12">
        <i class='bx bx-map-pin text-gray-400 text-3xl mb-2'></i>
        <p class="font-semibold text-xs">No services found</p>
        <p class="text-gray-600 text-xs text-center">Try expanding your search radius</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="max-w-md mx-auto px-4 py-1">
      <div class="flex items-center justify-around">
        <div class="nav-item active" onclick="switchPage('home')">
          <i class='bx bx-home-alt'></i>
          <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchPage('weather')">
          <i class='bx bx-cloud'></i>
          <span>Weather</span>
        </div>
        <div class="nav-item" onclick="switchPage('alerts')">
          <i class='bx bx-bell'></i>
          <span>Alerts</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let userLocation = null;
    const API_BASE_URL = 'https://app.pezamw.com';
    const apiKey = 'b0497bc522524401831134643231610';
    let currentAlerts = [];
    let weatherData = null;
    let currentPage = 'home';

    // Page Navigation
    function switchPage(page) {
      currentPage = page;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(page + 'Page').classList.add('active');
      event.target.closest('.nav-item').classList.add('active');
      
      if (page === 'weather') {
        updateWeatherDisplay();
      }
    }

    // Greeting
    function updateWelcomeMessage() {
      const hour = new Date().getHours();
      const welcomeTitle = document.getElementById('welcome-title');
      const username = "{{ user.username }}" || "Guest";
      if (hour < 12) welcomeTitle.textContent = `Mwadzuka, ${username}!`;
      else if (hour < 17) welcomeTitle.textContent = `Mwaswera bwanji, ${username}!`;
      else welcomeTitle.textContent = `Mulibwanji, ${username}!`;
    }

    // Location
    function getCurrentLocation() {
      const locationText = document.getElementById('locationText');
      if (navigator.geolocation) {
        locationText.innerHTML = '<span class="status-dot green"></span>Getting location...';
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            locationText.innerHTML = '<span class="status-dot green"></span>Connected';
            fetchWeatherAndAlerts();
          },
          err => {
            console.error('Location error:', err);
            locationText.innerHTML = '<span class="status-dot red"></span>Location unavailable';
            userLocation = { lat: -13.9626, lon: 33.7741 };
            fetchWeatherAndAlerts();
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        locationText.innerHTML = '<span class="status-dot red"></span>Not supported';
        userLocation = { lat: -13.9626, lon: 33.7741 };
        fetchWeatherAndAlerts();
      }
    }

    function refreshLocation() {
      getCurrentLocation();
    }

    // Services
    async function findService(category) {
      if (!userLocation) return alert('Location not detected yet');
      const modal = document.getElementById('resultsModal');
      const loadingState = document.getElementById('loadingState');
      const resultsList = document.getElementById('resultsList');
      const noResults = document.getElementById('noResults');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');

      const titles = { 
        police: 'Police Stations', 
        hospital: 'Hospitals', 
        ambulance: 'Ambulance Services', 
        fire: 'Fire Stations' 
      };
      modalTitle.textContent = titles[category] || 'Emergency Services';
      modalSubtitle.textContent = 'Searching nearby...';
      modal.classList.remove('hidden');
      loadingState.classList.remove('hidden');
      resultsList.classList.add('hidden');
      noResults.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE_URL}/api/peza/?lat=${userLocation.lat}&lon=${userLocation.lon}&category=${category}`);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        loadingState.classList.add('hidden');
        modalSubtitle.textContent = `Found ${data.locations?.length || 0} locations`;
        data.locations?.length ? displayResults(data.locations, category) : noResults.classList.remove('hidden');
      } catch (err) {
        console.error('Error:', err);
        loadingState.classList.add('hidden');
        noResults.classList.remove('hidden');
      }
    }

    function displayResults(locations, category) {
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '';
      resultsList.classList.remove('hidden');

      const icons = { 
        police: 'bxs-shield', 
        hospital: 'bxs-hospital', 
        ambulance: 'bxs-ambulance', 
        fire: 'bxs-fire' 
      };
      const colors = { 
        police: '#00a884', 
        hospital: '#d32f2f', 
        ambulance: '#2e7d32', 
        fire: '#f57c00' 
      };

      locations.forEach((loc, i) => {
        const item = document.createElement('div');
        item.className = 'whatsapp-shadow rounded-12px p-3 slide-up';
        item.style.animationDelay = `${i * 0.05}s`;
        item.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: ${colors[category]}20;">
              <i class='bx ${icons[category]}' style="color: ${colors[category]}; font-size: 16px;"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-sm mb-1 truncate">${loc.name}</h4>
              <p class="text-gray-600 text-xs mb-2 line-clamp-2">${loc.address}</p>
              <div class="flex items-center gap-2 mb-2 text-xs text-gray-600">
                <i class='bx bx-map-pin'></i>
                <span>${loc.distance}</span>
              </div>
              <div class="flex gap-2">
                <button onclick="callLocation('${loc.phone || 'N/A'}')" class="flex-1 bg-[#00a884] hover:bg-[#008c6e] text-white px-3 py-1 rounded-lg text-xs font-medium flex items-center justify-center gap-1 transition">
                  <i class='bx bx-phone-call text-xs'></i> Call
                </button>
                <button onclick="openMaps(${loc.lat}, ${loc.lon}, '${loc.name}')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-[#111b21] px-3 py-1 rounded-lg text-xs font-medium flex items-center justify-center gap-1 transition">
                  <i class='bx bx-navigation text-xs'></i> Directions
                </button>
              </div>
            </div>
          </div>
        `;
        resultsList.appendChild(item);
      });
    }

    function callLocation(phone) {
      if (phone === 'N/A') return alert('Phone number not available');
      window.location.href = `tel:${phone}`;
    }

    function openMaps(lat, lon, name) {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&destination_place_id=${encodeURIComponent(name)}`, '_blank');
    }

    function closeModal() {
      document.getElementById('resultsModal').classList.add('hidden');
    }

    // Weather Display
    function updateWeatherDisplay() {
      if (!weatherData) return;
      
      const { current, location } = weatherData;
      document.getElementById('mainTemp').textContent = `${Math.round(current.temp_c)}°C`;
      document.getElementById('weatherCondition').textContent = current.condition.text;
      document.getElementById('weatherLocation').textContent = `${location.name}, ${location.country}`;
      document.getElementById('humidity').textContent = `${current.humidity}%`;
      document.getElementById('windSpeed').textContent = `${Math.round(current.wind_kph)} km/h`;
      document.getElementById('uvIndex').textContent = current.uv;
      
      const condition = current.condition.text.toLowerCase();
      let iconClass = 'bx-cloud';
      if (condition.includes('sun') || condition.includes('clear')) iconClass = 'bx-sun';
      else if (condition.includes('rain')) iconClass = 'bx-cloud-rain';
      else if (condition.includes('snow')) iconClass = 'bx-cloud-snow';
      else if (condition.includes('storm') || condition.includes('thunder')) iconClass = 'bx-cloud-lightning';
      else if (condition.includes('fog') || condition.includes('mist')) iconClass = 'bxs-cloud';
      
      document.getElementById('weatherIcon').className = `bx ${iconClass} text-4xl mb-2`;
      
      const weatherAlerts = currentAlerts.filter(a => a.type === 'weather');
      const weatherAlertsList = document.getElementById('weatherAlertsList');
      const weatherAlertCount = document.getElementById('weatherAlertCount');
      
      if (weatherAlerts.length === 0) {
        weatherAlertsList.innerHTML = '<p class="text-center text-gray-600 text-xs py-2">No weather alerts</p>';
        weatherAlertCount.textContent = '0 alerts';
      } else {
        weatherAlertsList.innerHTML = '';
        weatherAlerts.forEach(alert => {
          weatherAlertsList.appendChild(createAlertElement(alert));
        });
        weatherAlertCount.textContent = `${weatherAlerts.length} alert${weatherAlerts.length > 1 ? 's' : ''}`;
      }
    }

    // Alerts
    function getAlertIcon(type, severity) {
      const icons = {
        safety: {
          high: 'bxs-error',
          medium: 'bxs-lock',
          low: 'bxs-info-circle'
        },
        time: {
          high: 'bxs-moon',
          medium: 'bxs-traffic',
          low: 'bxs-time'
        },
        weather: {
          rain: 'bxs-cloud-rain',
          sun: 'bxs-sun',
          snow: 'bxs-cloud-snow',
          wind: 'bxs-wind',
          default: 'bxs-cloud'
        }
      };
      return icons[type]?.[severity] || icons[type]?.default || icons.safety.low;
    }

    function createAlertElement(alert) {
      const div = document.createElement('div');
      div.className = `alert-item slide-up`;
      div.setAttribute('data-priority', alert.severity);
      div.setAttribute('data-type', alert.type);
      div.innerHTML = `
        <div class="alert-icon ${alert.type === 'weather' ? 'weather' : alert.type === 'time' ? 'time' : alert.severity}">
          <i class='bx ${getAlertIcon(alert.type, alert.severity)}'></i>
        </div>
        <div class="alert-content">
          <div class="flex items-center justify-between mb-1">
            <div class="alert-title">${alert.title}</div>
            <span class="alert-badge ${alert.type === 'weather' ? 'weather' : alert.type === 'time' ? 'time' : alert.severity}">
              ${alert.type === 'weather' ? 'Weather' : alert.type === 'time' ? 'Time-based' : alert.severity.charAt(0).toUpperCase() + alert.severity.slice(1)}
            </span>
          </div>
          <div class="alert-message">${alert.message}</div>
          ${alert.recommendation ? `<div class="alert-recommendation">Tip: ${alert.recommendation}</div>` : ''}
          <div class="alert-time">${new Date().toLocaleTimeString()} • Live</div>
        </div>
      `;
      return div;
    }

    function checkTimeBasedAlerts(hour) {
      const alerts = [];
      
      if (hour >= 21 || hour <= 5) {
        if (hour >= 0 && hour <= 3) {
          alerts.push({
            type: 'time',
            title: 'Very Late Night - High Risk',
            message: 'This is the most dangerous time period. Crime rates are highest between midnight and 3 AM.',
            recommendation: 'Stay indoors if possible. If you must go out, travel in groups and stay in well-lit areas.',
            severity: 'high'
          });
        } else {
          alerts.push({
            type: 'time',
            title: 'Night Time Safety Alert',
            message: 'Increased risk of crime during late hours. Limited visibility and fewer people around.',
            recommendation: 'Avoid walking alone. Keep phone charged and share location with trusted contacts.',
            severity: hour >= 22 || hour <= 4 ? 'high' : 'medium'
          });
        }
      }
      
      if (hour >= 6 && hour <= 8) {
        alerts.push({
          type: 'time',
          title: 'Morning Rush Hour',
          message: 'Heavy traffic and crowded streets. Increased risk of accidents and petty theft.',
          recommendation: 'Use designated crosswalks. Keep valuables secure in crowds. Allow extra travel time.',
          severity: 'medium'
        });
      }
      
      if (hour >= 12 && hour <= 13) {
        alerts.push({
          type: 'time',
          title: 'Lunch Hour Rush',
          message: 'Busy period with increased foot traffic in commercial areas.',
          recommendation: 'Be aware of your surroundings. Watch for pickpockets in crowded places.',
          severity: 'low'
        });
      }
      
      if (hour >= 17 && hour <= 19) {
        alerts.push({
          type: 'time',
          title: 'Evening Rush Hour',
          message: 'Peak traffic time. Roads are congested and visibility may be reduced as it gets darker.',
          recommendation: 'Drive defensively. Use headlights. Avoid busy intersections if possible.',
          severity: 'medium'
        });
      }
      
      if (hour >= 19 && hour <= 20) {
        alerts.push({
          type: 'time',
          title: 'Evening Transition Period',
          message: 'Daylight fading. This is when many crimes begin to increase.',
          recommendation: 'Head home before it gets too late. Be extra vigilant in parking areas.',
          severity: 'medium'
        });
      }
      
      if (hour >= 9 && hour <= 16) {
        alerts.push({
          type: 'time',
          title: 'Daytime Hours - Lower Risk',
          message: 'This is generally the safest time period with good visibility and more people around.',
          recommendation: 'Still remain aware of your surroundings. Report any suspicious activity.',
          severity: 'low'
        });
      }
      
      return alerts;
    }

    function checkWeatherAlerts(data) {
      const alerts = [];
      const { temp_c: temp, condition: { text: condition }, humidity, wind_kph: wind, uv } = data.current;

      if (temp > 35) {
        alerts.push({ 
          type: 'weather', 
          title: 'Extreme Heat Warning', 
          message: `Temperature: ${temp}°C. Risk of heat exhaustion and heat stroke.`, 
          recommendation: 'Stay hydrated, avoid direct sunlight, seek air-conditioned spaces.', 
          severity: 'high' 
        });
      } else if (temp > 30) {
        alerts.push({ 
          type: 'weather', 
          title: 'Hot Weather Alert', 
          message: `Temperature: ${temp}°C. High heat conditions.`, 
          recommendation: 'Use sunscreen SPF 30+, wear light clothing, drink plenty of water.', 
          severity: 'medium' 
        });
      } else if (temp < 5) {
        alerts.push({ 
          type: 'weather', 
          title: 'Cold Weather Warning', 
          message: `Temperature: ${temp}°C. Risk of hypothermia.`, 
          recommendation: 'Dress in layers, cover extremities, limit time outdoors.', 
          severity: 'high' 
        });
      } else if (temp < 10) {
        alerts.push({ 
          type: 'weather', 
          title: 'Chilly Weather', 
          message: `Temperature: ${temp}°C. Cold conditions.`, 
          recommendation: 'Wear warm clothing, especially in wind.', 
          severity: 'low' 
        });
      }

      if (condition.toLowerCase().includes('rain')) {
        const severity = condition.toLowerCase().includes('heavy') ? 'high' : 'medium';
        alerts.push({ 
          type: 'weather', 
          title: severity === 'high' ? 'Heavy Rain Warning' : 'Rain Alert', 
          message: 'Wet conditions causing slippery roads and reduced visibility.', 
          recommendation: 'Use umbrella, drive slowly, watch for flooding in low areas.', 
          severity 
        });
      }
      
      if (condition.toLowerCase().includes('snow')) {
        alerts.push({ 
          type: 'weather', 
          title: 'Snow Alert', 
          message: 'Snowy conditions with slippery surfaces and reduced visibility.', 
          recommendation: 'Wear waterproof boots, drive very carefully, allow extra travel time.', 
          severity: 'high' 
        });
      }
      
      if (condition.toLowerCase().includes('thunderstorm') || condition.toLowerCase().includes('thunder')) {
        alerts.push({ 
          type: 'weather', 
          title: 'Thunderstorm Warning', 
          message: 'Active thunderstorm with lightning risk. Dangerous conditions.', 
          recommendation: 'Stay indoors, avoid trees and open areas, unplug electronics.', 
          severity: 'high' 
        });
      }

      if (wind > 50) {
        alerts.push({ 
          type: 'weather', 
          title: 'Severe Wind Warning', 
          message: `Wind speed: ${wind} km/h. Risk of flying debris and property damage.`, 
          recommendation: 'Stay indoors, secure loose objects, avoid driving high-profile vehicles.', 
          severity: 'high' 
        });
      } else if (wind > 40) {
        alerts.push({ 
          type: 'weather', 
          title: 'High Wind Alert', 
          message: `Wind speed: ${wind} km/h. Strong gusts possible.`, 
          recommendation: 'Secure outdoor items, be careful when walking near buildings.', 
          severity: 'medium' 
        });
      }

      if (uv > 10) {
        alerts.push({ 
          type: 'weather', 
          title: 'Extreme UV Warning', 
          message: `UV Index: ${uv}. Very high risk of sun damage.`, 
          recommendation: 'Avoid sun 10 AM-4 PM, use SPF 50+, wear protective clothing and sunglasses.', 
          severity: 'high' 
        });
      } else if (uv > 7) {
        alerts.push({ 
          type: 'weather', 
          title: 'High UV Alert', 
          message: `UV Index: ${uv}. Significant sun exposure risk.`, 
          recommendation: 'Use SPF 30+ sunscreen, wear hat and sunglasses, seek shade.', 
          severity: 'medium' 
        });
      }

      if (humidity > 85) {
        alerts.push({ 
          type: 'weather', 
          title: 'Very High Humidity', 
          message: `Humidity: ${humidity}%. Oppressive conditions, feels hotter than actual temperature.`, 
          recommendation: 'Stay hydrated, use dehumidifier indoors, limit strenuous activity.', 
          severity: 'medium' 
        });
      } else if (humidity > 80) {
        alerts.push({ 
          type: 'weather', 
          title: 'High Humidity Notice', 
          message: `Humidity: ${humidity}%. Muggy conditions.`, 
          recommendation: 'Stay cool and hydrated.', 
          severity: 'low' 
        });
      }

      return alerts;
    }

    function displayAlerts(alerts) {
      const container = document.getElementById('alerts-list');
      const noAlertsDiv = document.getElementById('no-alerts');
      const alertCount = document.getElementById('alert-count');
      const homeAlertCount = document.getElementById('homeAlertCount');
      
      container.innerHTML = '';
      
      if (!alerts.length) {
        noAlertsDiv.classList.remove('hidden');
        alertCount.textContent = '0';
        homeAlertCount.textContent = '0';
        return;
      }
      
      noAlertsDiv.classList.add('hidden');
      alertCount.textContent = alerts.length;
      homeAlertCount.textContent = alerts.length;
      
      alerts.forEach(alert => container.appendChild(createAlertElement(alert)));
    }

    function updateTimeAndAlerts() {
      const now = new Date();
      document.getElementById('current-time').textContent = `Last updated: ${now.toLocaleTimeString()}`;
      
      const timeAlerts = checkTimeBasedAlerts(now.getHours());
      const weatherAlerts = weatherData ? checkWeatherAlerts(weatherData) : [];
      
      currentAlerts = [...timeAlerts, ...weatherAlerts];
      displayAlerts(currentAlerts);
      
      if (currentPage === 'weather') {
        updateWeatherDisplay();
      }
    }

    async function fetchWeatherAndAlerts() {
      if (userLocation) {
        try {
          const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${userLocation.lat},${userLocation.lon}`);
          if (!res.ok) throw new Error('Weather fetch failed');
          weatherData = await res.json();
        } catch (err) {
          console.error('Weather error:', err);
          document.getElementById('weatherLocation').textContent = 'Weather data unavailable';
        }
      }
      updateTimeAndAlerts();
    }

    function refreshAlerts() {
      fetchWeatherAndAlerts();
    }

    function filterAlerts(filter) {
      const alerts = document.querySelectorAll('.alert-item');
      const buttons = document.querySelectorAll('.filter-btn');
      
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      let visibleCount = 0;
      alerts.forEach(alert => {
        const priority = alert.getAttribute('data-priority');
        const type = alert.getAttribute('data-type');
        const show = filter === 'all' || priority === filter || type === filter;
        alert.style.display = show ? 'flex' : 'none';
        if (show) visibleCount++;
      });
      
      document.getElementById('alert-count').textContent = visibleCount;
      document.getElementById('no-alerts').style.display = visibleCount ? 'none' : 'block';
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      updateWelcomeMessage();
      getCurrentLocation();
      setInterval(updateTimeAndAlerts, 60000);
    });

    document.getElementById('resultsModal').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.getElementById('alertSearch').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const alerts = document.querySelectorAll('.alert-item');
      let visibleCount = 0;
      
      alerts.forEach(alert => {
        const content = alert.textContent.toLowerCase();
        const show = content.includes(term);
        alert.style.display = show ? 'flex' : 'none';
        if (show) visibleCount++;
      });
      
      document.getElementById('alert-count').textContent = visibleCount;
      document.getElementById('no-alerts').style.display = visibleCount ? 'none' : 'block';
    });
  </script>
</body>
</html>